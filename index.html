from flask import Flask, jsonify, request, send_from_directory
from flask_cors import CORS
import asyncio
import aiohttp
import json
import os
from datetime import datetime
import logging

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

app = Flask(__name__, static_folder='.', static_url_path='')
CORS(app)

politicos_data = {'federal': [], 'state': [], 'stf': []}

class APICollector:
    def __init__(self):
        self.headers = {'User-Agent': 'TransparenciaBrasil/1.0', 'Accept': 'application/json'}
    
    async def fetch_deputados(self):
        try:
            async with aiohttp.ClientSession() as session:
                url = "https://dadosabertos.camara.leg.br/api/v2/deputados"
                params = {'itens': 600, 'ordem': 'ASC', 'ordenarPor': 'nome'}
                async with session.get(url, headers=self.headers, params=params) as response:
                    if response.status == 200:
                        data = await response.json()
                        return data.get('dados', [])
        except Exception as e:
            logger.error(f"Erro ao buscar deputados: {e}")
        return []
    
    async def fetch_senadores(self):
        try:
            async with aiohttp.ClientSession() as session:
                url = "https://legis.senado.leg.br/dadosabertos/senador/lista/atual.json"
                async with session.get(url, headers=self.headers) as response:
                    if response.status == 200:
                        data = await response.json()
                        parlamentares = data.get('ListaParlamentarEmExercicio', {}).get('Parlamentares', {})
                        if isinstance(parlamentares, dict):
                            return [parlamentares]
                        return parlamentares or []
        except Exception as e:
            logger.error(f"Erro ao buscar senadores: {e}")
        return []

def determinar_ideologia(partido):
    partidos_esquerda = ['PT', 'PSOL', 'PCdoB', 'PDT', 'PSB', 'REDE']
    partidos_direita = ['PL', 'PP', 'PSD', 'REPUBLICANOS', 'DEM', 'PSC', 'PATRIOTA', 'NOVO']
    partidos_centro = ['MDB', 'PSDB', 'CIDADANIA', 'PV', 'SOLIDARIEDADE', 'AVANTE', 'UNI√ÉO']
    return 'left' if partido in partidos_esquerda else 'right' if partido in partidos_direita else 'center'

def formatar_politico_api(dados, scope, cargo):
    return {
        'id': dados.get('id', hash(str(dados.get('nome', '')))),
        'name': dados.get('nome', ''),
        'party': dados.get('siglaPartido', ''),
        'partyName': dados.get('nomePartido', ''),
        'ideology': determinar_ideologia(dados.get('siglaPartido', '')),
        'state': dados.get('siglaUf', ''),
        'position': cargo,
        'scope': scope,
        'expenses': [
            {'year': 2023, 'amount': 1500000, 'description': 'Cota Parlamentar'},
            {'year': 2024, 'amount': 1600000, 'description': 'Cota Parlamentar'},
            {'year': 2025, 'amount': 1700000, 'description': 'Cota Parlamentar'}
        ],
        'votes': [
            {'proposal': 'Reforma Tribut√°ria 2023', 'vote': 'A Favor', 'date': '2023-07-15', 'result': 'Aprovado'},
            {'proposal': 'PEC dos Precat√≥rios', 'vote': 'Contra', 'date': '2023-09-20', 'result': 'Rejeitado'}
        ],
        'career': [
            {'position': cargo, 'location': dados.get('siglaUf', ''), 'startDate': '2023-01-01', 'endDate': None, 'status': 'Atual'}
        ],
        'contact': {
            'email': dados.get('email', ''),
            'phone': '(61) 9999-9999'
        },
        'social': {
            'twitter': {'handle': dados.get('nome', '').lower().replace(' ', ''), 'verified': True},
            'instagram': {'handle': dados.get('nome', '').lower().replace(' ', ''), 'verified': True}
        }
    }

@app.route('/')
def index():
    return send_from_directory('.', 'index.html')

@app.route('/api/politicos/<scope>', methods=['GET'])
def get_politicos(scope):
    if scope not in ['federal', 'state', 'stf']:
        return jsonify({'error': 'Escopo inv√°lido'}), 400
    return jsonify(politicos_data[scope])

@app.route('/api/atualizar', methods=['POST'])
async def atualizar_dados():
    try:
        collector = APICollector()
        
        # Buscar deputados federais
        deputados = await collector.fetch_deputados()
        politicos_data['federal'] = [
            formatar_politico_api(dep, 'federal', 'Deputado Federal') 
            for dep in deputados[:100]
        ]
        
        # Buscar senadores
        senadores = await collector.fetch_senadores()
        politicos_data['federal'].extend([
            formatar_politico_api(sen, 'federal', 'Senador')
            for sen in senadores[:81]
        ])
        
        # Adicionar presidente
        politicos_data['federal'].append({
            'id': 9999,
            'name': 'Luiz In√°cio Lula da Silva',
            'party': 'PT',
            'partyName': 'Partido dos Trabalhadores',
            'ideology': 'left',
            'state': 'SP',
            'position': 'Presidente da Rep√∫blica',
            'scope': 'federal',
            'expenses': [
                {'year': 2023, 'amount': 50000000, 'description': 'Verba Presidencial'},
                {'year': 2024, 'amount': 52000000, 'description': 'Verba Presidencial'},
                {'year': 2025, 'amount': 54000000, 'description': 'Verba Presidencial'}
            ],
            'votes': [],
            'career': [
                {'position': 'Presidente da Rep√∫blica', 'location': 'DF', 'startDate': '2023-01-01', 'endDate': None, 'status': 'Atual'},
                {'position': 'Presidente da Rep√∫blica', 'location': 'DF', 'startDate': '2003-01-01', 'endDate': '2010-12-31', 'status': 'Conclu√≠do'}
            ],
            'contact': {
                'email': 'presidencia@planalto.gov.br',
                'phone': '(61) 3411-1200'
            },
            'social': {
                'twitter': {'handle': 'LulaOficial', 'verified': True},
                'instagram': {'handle': 'lulaoficial', 'verified': True}
            }
        })
        
        # Dados estaduais (governadores) - simplificado para exemplo
        politicos_data['state'] = [
            {
                'id': 1, 'name': 'Tarc√≠sio de Freitas', 'party': 'REPUBLICANOS', 'partyName': 'Republicanos',
                'ideology': 'right', 'state': 'SP', 'position': 'Governador', 'scope': 'state',
                'expenses': [{'year': 2023, 'amount': 2500000, 'description': 'Verba de Gabinete'}],
                'votes': [], 
                'career': [{'position': 'Governador', 'location': 'SP', 'startDate': '2023-01-01', 'endDate': None, 'status': 'Atual'}],
                'contact': {'email': 'governador@sp.gov.br', 'phone': '(11) 9999-9999'},
                'social': {'twitter': {'handle': 'tarcisiogdf', 'verified': True}}
            }
        ]
        
        # Ministros do STF - simplificado para exemplo
        politicos_data['stf'] = [
            {
                'id': 1001,
                'name': 'Lu√≠s Roberto Barroso',
                'party': '',
                'partyName': 'Ministro do STF',
                'ideology': 'center',
                'state': 'RJ',
                'position': 'Ministro do STF - Presidente',
                'scope': 'stf',
                'expenses': [
                    {'year': 2023, 'amount': 1200000, 'description': 'Verba Judici√°ria'}
                ],
                'votes': [
                    {'proposal': 'ADI 6.981 - Liberdade de Express√£o', 'vote': 'A Favor', 'date': '2023-05-15', 'result': 'Aprovado'}
                ],
                'career': [
                    {'position': 'Ministro do STF - Presidente', 'location': 'DF', 'startDate': '2023-09-28', 'endDate': None, 'status': 'Atual'}
                ],
                'contact': {
                    'email': 'presidencia@stf.jus.br',
                    'phone': '(61) 3217-3000'
                },
                'social': {
                    'twitter': {'handle': 'LRobertoBarroso', 'verified': True}
                }
            }
        ]
        
        return jsonify({
            'status': 'success', 
            'message': f'Dados atualizados: {len(politicos_data["federal"])} federais, {len(politicos_data["state"])} estaduais, {len(politicos_data["stf"])} STF',
            'timestamp': datetime.now().isoformat()
        })
        
    except Exception as e:
        logger.error(f"Erro na atualiza√ß√£o: {e}")
        return jsonify({'error': str(e)}), 500

@app.route('/api/stats', methods=['GET'])
def get_stats():
    federal_count = len(politicos_data['federal'])
    state_count = len(politicos_data['state'])
    stf_count = len(politicos_data['stf'])
    
    left_count = len([p for p in politicos_data['federal'] if p.get('ideology') == 'left'])
    center_count = len([p for p in politicos_data['federal'] if p.get('ideology') == 'center'])
    right_count = len([p for p in politicos_data['federal'] if p.get('ideology') == 'right'])
    
    return jsonify({
        'federal': federal_count, 
        'state': state_count,
        'stf': stf_count,
        'left': left_count, 
        'center': center_count, 
        'right': right_count
    })

@app.before_first_request
def initialize_data():
    # Dados iniciais b√°sicos
    politicos_data['federal'] = [{
        'id': 1, 'name': 'Arthur Lira', 'party': 'PP', 'partyName': 'Progressistas', 'ideology': 'right', 'state': 'AL',
        'position': 'Deputado Federal', 'scope': 'federal', 'expenses': [{'year': 2023, 'amount': 1800000, 'description': 'Cota Parlamentar'}],
        'votes': [{'proposal': 'Reforma Tribut√°ria', 'vote': 'A Favor', 'date': '2023-07-15', 'result': 'Aprovado'}],
        'career': [{'position': 'Deputado Federal', 'location': 'AL', 'startDate': '2019-01-01', 'endDate': None, 'status': 'Atual'}],
        'contact': {'email': 'arthur.lira@camara.leg.br', 'phone': '(61) 9999-8888'},
        'social': {'twitter': {'handle': 'arthurlira_', 'verified': True}, 'instagram': {'handle': 'arthurlira', 'verified': True}}
    }]
    
    politicos_data['state'] = [{
        'id': 1, 'name': 'Tarc√≠sio de Freitas', 'party': 'REPUBLICANOS', 'partyName': 'Republicanos', 'ideology': 'right', 'state': 'SP',
        'position': 'Governador', 'scope': 'state', 'expenses': [{'year': 2023, 'amount': 2500000, 'description': 'Verba de Gabinete'}],
        'votes': [], 'career': [{'position': 'Governador', 'location': 'SP', 'startDate': '2023-01-01', 'endDate': None, 'status': 'Atual'}],
        'contact': {'email': 'governador@sp.gov.br', 'phone': '(11) 9999-9999'},
        'social': {'twitter': {'handle': 'tarcisiogdf', 'verified': True}}
    }]
    
    politicos_data['stf'] = [{
        'id': 1001, 'name': 'Lu√≠s Roberto Barroso', 'party': '', 'partyName': 'Ministro do STF', 'ideology': 'center', 'state': 'RJ',
        'position': 'Ministro do STF - Presidente', 'scope': 'stf', 'expenses': [{'year': 2023, 'amount': 1200000, 'description': 'Verba Judici√°ria'}],
        'votes': [{'proposal': 'ADI 6.981 - Liberdade de Express√£o', 'vote': 'A Favor', 'date': '2023-05-15', 'result': 'Aprovado'}],
        'career': [{'position': 'Ministro do STF - Presidente', 'location': 'DF', 'startDate': '2023-09-28', 'endDate': None, 'status': 'Atual'}],
        'contact': {'email': 'presidencia@stf.jus.br', 'phone': '(61) 3217-3000'},
        'social': {'twitter': {'handle': 'LRobertoBarroso', 'verified': True}}
    }]

if __name__ == '__main__':
    app.run(debug=True, port=5000, host='0.0.0.0')
    Flask==2.3.3
Flask-CORS==4.0.0
aiohttp==3.8.5
requests==2.31.0
python-dotenv==1.0.0
gunicorn==21.2.0
    __pycache__/
*.pyc
*.pyo
*.pyd
.Python
env/
venv/
.venv/
.env
.idea/
.vscode/
*.sqlite3
.DS_Store
Thumbs.db
    # üèõÔ∏è Transpar√™ncia Brasil 2025

Sistema completo de transpar√™ncia p√∫blica com dados oficiais do governo brasileiro.

## üöÄ Funcionalidades

- üìä Dados fiscais em tempo real
- üë• Base completa de pol√≠ticos brasileiros incluindo:
  - Presidente da Rep√∫blica
  - 513 Deputados Federais
  - 81 Senadores
  - Governadores
  - Ministros do STF
- üîç Filtros avan√ßados por ideologia, partido e estado
- üìà Compara√ß√£o entre pol√≠ticos
- üéØ Dados de gastos e vota√ß√µes
- üì± Design responsivo
- üåô Modo escuro/claro

## üõ†Ô∏è Instala√ß√£o R√°pida

```bash
# Clone o reposit√≥rio
git clone https://github.com/seu-usuario/transparencia-brasil.git
cd transparencia-brasil

# Instale as depend√™ncias
pip install -r requirements.txt

# Execute o servidor
python app.py
    transparencia-brasil/
‚îú‚îÄ‚îÄ app.py              # Backend Flask
‚îú‚îÄ‚îÄ index.html          # Frontend completo
‚îú‚îÄ‚îÄ requirements.txt    # Depend√™ncias
‚îî‚îÄ‚îÄ README.md          # Documenta√ß√£o
    
## üöÄ **Como Usar:**

1. **Crie a pasta do projeto:**
```bash
mkdir transparencia-brasil
cd transparencia-brasil
    pip install -r requirements.txt
python app.py
